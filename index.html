<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Escape Game Lyon - Parcours Culturel</title>
  <style>
    body { margin: 0; font-family: "Segoe UI", sans-serif; background: #f9f9f9; }
    #map { height: 60vh; width: 100%; }

    #game {
      padding: 15px;
      max-width: 600px;
      margin: auto;
    }

    h1 {
      text-align: center;
      font-size: 1.8em;
      color: #2c3e50;
      cursor: pointer; /* pour cliquer sur üóùÔ∏è */
    }

    #status {
      margin: 15px 0;
      font-size: 1.1em;
      text-align: center;
      color: #34495e;
    }

    #question-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0px 4px 12px rgba(0,0,0,0.1);
      margin-top: 20px;
      transition: 0.3s;
    }

    #question {
      font-weight: bold;
      margin-bottom: 15px;
      font-size: 1.1em;
      color: #2c3e50;
    }

    #answer {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 10px;
      font-size: 1em;
    }

    button {
      background: #3498db;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      transition: 0.2s;
    }
    button:hover { background: #2980b9; }

    #culture-box {
      margin-top: 20px;
      padding: 15px;
      background: #ecf0f1;
      border-left: 5px solid #3498db;
      border-radius: 8px;
      display: none;
      opacity: 0;
      transition: opacity 1s ease-in;
    }

    #culture-box.show {
      display: block;
      opacity: 1;
    }

    /* Responsive */
    @media (max-width: 600px) {
      #map { height: 50vh; }
      h1 { font-size: 1.4em; }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="game">
    <h1 onclick="toggleTestMode()">Escape Game Lyon üóùÔ∏è</h1>
    <p id="status">üìç En attente de votre position...</p>

    <div id="question-container" class="hidden">
      <p id="question"></p>
      <input type="text" id="answer" placeholder="Votre r√©ponse">
      <button id="validate-btn" onclick="checkAnswer()" disabled>Valider</button>
      <button id="next-btn" onclick="nextStep()" style="display:none; margin-left:10px;">√âtape suivante</button>
    </div>

    <!-- Box culture -->
    <div id="culture-box"></div>
  </div>

  <script>
    let map, playerMarker;
    let currentStep = 0;
    let testMode = false;

    // √âtapes du parcours
    const steps = [
      { coords: { lat: 45.757824, lng: 4.832011 }, // Bellecour
        question: "Cherche le regard du roi de bronze, tourn√© vers l‚Äôest, car dans la lumi√®re qui √©claire le monde, tu trouveras la v√©rit√© !",
        answer: "Soleil",
        culture: "La statue √©questre de Louis XIV, inaugur√©e en 1825 sur la Place Bellecour, est une ≈ìuvre du sculpteur Fran√ßois-Fr√©d√©ric Lemot. D√©tail marquant : seuls deux sabots du cheval touchent le sol. Bellecour, plus grande place pi√©tonne d‚ÄôEurope, fut jadis un terrain militaire et un lieu de rassemblements r√©volutionnaires.",
        image: "https://upload.wikimedia.org/wikipedia/commons/3/38/Place_Bellecour_Lyon.jpg"
      },
      { coords: { lat: 45.7609582, lng: 4.8264863 }, // Cath√©drale
        question: "L√®ve la t√™te et fais face au gardien du temps ! Que vois-tu ?",
        answer: "Horloge",
        culture: "L‚Äôhorloge astronomique de la Cath√©drale Saint-Jean date du XIV·µâ si√®cle. Elle indique l‚Äôheure, les positions du soleil et de la lune, et ses automates s‚Äôaniment chaque jour √† midi. Chef-d‚Äô≈ìuvre gothique et roman, la cath√©drale fut t√©moin de couronnements et de visites papales.",
        image: "https://upload.wikimedia.org/wikipedia/commons/9/9d/Cathedrale_Saint-Jean-Baptiste_de_Lyon.jpg"
      },
      { coords: { lat: 45.760097, lng: 4.827132 }, // Rue Merci√®re
        question: "La rue te remercie de ta visite. Sauras-tu la distinguer ?",
        answer: "Rue Merci√®re",
        culture: "Au Moyen √Çge, la rue Merci√®re abritait imprimeurs et libraires. Elle fut l‚Äôun des foyers de l‚Äôimprimerie lyonnaise, contribuant √† faire de la ville la deuxi√®me capitale europ√©enne du livre au XVI·µâ si√®cle. Aujourd‚Äôhui, elle est c√©l√®bre pour ses bouchons lyonnais o√π l‚Äôon d√©guste quenelles et andouillettes.",
        image: "https://upload.wikimedia.org/wikipedia/commons/8/83/Rue_Merci%C3%A8re_Lyon.jpg"
      },
      { coords: { lat: 45.762391‚ÄØ, lng: 4.822415‚ÄØ }, // Fourvi√®re
        question: "Dans la crypte, il te faudra suivre le chemin de la v√©rit√© pour rester en vie. Quelle r√©f√©rence vois-tu ?",
        answer: "Jean 14:6",
        culture: "Dans la crypte de Fourvi√®re se trouve une mosa√Øque portant le verset : 'Je suis le chemin, la v√©rit√© et la vie'. La basilique, achev√©e en 1896, fut b√¢tie en remerciement √† la Vierge Marie. Elle m√™le style n√©o-byzantin et symbolisme religieux, et domine la ville comme protectrice des Lyonnais.",
        image: "https://upload.wikimedia.org/wikipedia/commons/f/f6/Basilique_Notre-Dame_de_Fourvi%C3%A8re_-_Lyon.jpg"
      },
      { coords: { lat: 45.767274, lng: 4.834307 }, // Fontaine Bartholdi
        question: "Devant toi, un char tir√© par des chevaux. Combien sont-ils sur la fontaine de Bartholdi ?",
        answer: "4",
        culture: "La Fontaine Bartholdi, install√©e Place des Terreaux en 1892, repr√©sente la France guid√©e par une femme all√©gorique, tir√©e par quatre chevaux incarnant les fleuves. ≈íuvre du sculpteur de la Statue de la Libert√©, elle symbolise la puissance et le mouvement de l‚Äôeau.",
        image: "https://upload.wikimedia.org/wikipedia/commons/5/5d/Fontaine_Bartholdi_Lyon.jpg"
      },
      { coords: { lat: 45.767564, lng: 4.835663 }, // Op√©ra
        question: "Combien de muses d√©corent le sommet de l‚ÄôOp√©ra de Lyon ?",
        answer: "8",
        culture: "R√©habilit√© par Jean Nouvel en 1993, l‚ÄôOp√©ra de Lyon m√™le fa√ßade n√©oclassique et architecture contemporaine. Son toit est surmont√© de huit muses, une de moins que dans la mythologie, pour laisser une place √† la cr√©ation moderne.",
        image: "https://upload.wikimedia.org/wikipedia/commons/7/70/Opera_de_Lyon.jpg"
      },
      { coords: { lat: 45.767582, lng: 4.827852 }, // Pont de la Feuill√©e
        question: "Quel pont traversez-vous ici avec vue sur la Sa√¥ne ?",
        answer: "Pont de la Feuill√©e",
        culture: "Construit en 1831, le Pont de la Feuill√©e fut le premier pont suspendu de Lyon. Il relie le Vieux Lyon √† la Presqu‚Äô√Æle et doit son nom √† un caf√© voisin tr√®s populaire au XIX·µâ si√®cle. Aujourd‚Äôhui, il offre une vue splendide sur la Sa√¥ne, le Vieux Lyon et Fourvi√®re.",
        image: "https://upload.wikimedia.org/wikipedia/commons/2/24/Pont_de_la_Feuill%C3%A9e_Lyon.jpg"
      }
    ];

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 15,
        center: steps[0].coords
      });

      const path = steps.map(step => step.coords);
      new google.maps.Polyline({
        path: path,
        geodesic: true,
        strokeColor: "#0000FF",
        strokeOpacity: 0.7,
        strokeWeight: 4,
        map: map
      });

      steps.forEach((step, i) => {
        new google.maps.Marker({
          position: step.coords,
          map: map,
          label: `${i + 1}`,
          title: `√âtape ${i + 1}`
        });
      });

      if (navigator.geolocation && !testMode) {
        navigator.geolocation.watchPosition(updatePosition, showError, { enableHighAccuracy: true });
      } else if (!testMode) {
        document.getElementById("status").innerText = "‚ùå La g√©olocalisation n'est pas support√©e.";
      }
    }

    function updatePosition(position) {
      if (testMode) return;
      const { latitude, longitude } = position.coords;

      if (!playerMarker) {
        playerMarker = new google.maps.Marker({
          position: { lat: latitude, lng: longitude },
          map: map,
          icon: { url: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png" }
        });
      } else {
        playerMarker.setPosition({ lat: latitude, lng: longitude });
      }

      let nearestStep = null;
let nearestDist = Infinity;

// Cherche l‚Äô√©tape la plus proche
steps.forEach((step, i) => {
  const d = distance(latitude, longitude, step.coords.lat, step.coords.lng);
  if (d < nearestDist) {
    nearestDist = d;
    nearestStep = i;
  }
});

// Affiche l‚Äôinfo de distance par rapport √† l‚Äô√©tape la plus proche
document.getElementById("status").innerText =
  `üéØ √âtape ${nearestStep + 1} - Distance : ${nearestDist.toFixed(0)} m`;

// Si on est assez proche, active cette √©tape
if (nearestDist < 50) {
  currentStep = nearestStep;   // üëâ On met √† jour l‚Äô√©tape en cours
  showQuestion(steps[currentStep].question);
  document.getElementById("validate-btn").disabled = false;
} else {
  document.getElementById("question-container").classList.add("hidden");
  document.getElementById("validate-btn").disabled = true;
}

    }

    function showError(err) {
      if (err.code === err.PERMISSION_DENIED) {
        document.getElementById("status").innerText = "‚ö†Ô∏è Vous devez autoriser la g√©olocalisation.";
      } else {
        document.getElementById("status").innerText = "‚ùå Erreur : " + err.message;
      }
    }

    function showQuestion(question) {
        document.getElementById("question").innerText = question;
        document.getElementById("question-container").classList.remove("hidden");

        // En mode test -> bouton valide direct
        if (testMode) {
        document.getElementById("validate-btn").disabled = false;
        }
    }

    function nextStep() {
    currentStep++;
    if (currentStep >= steps.length) {
        document.getElementById("status").innerText = "üéâ Fin du mode test : toutes les √©tapes sont termin√©es.";
        document.getElementById("question-container").classList.add("hidden");
        return;
    }
    showQuestion(steps[currentStep].question);
    document.getElementById("status").innerText = `‚û°Ô∏è √âtape ${currentStep + 1} (mode test)`;
    document.getElementById("answer").value = "";
    document.getElementById("culture-box").classList.remove("show");
    }


    function checkAnswer() {
      const input = document.getElementById("answer").value.trim().toLowerCase();
      const correct = steps[currentStep].answer.toLowerCase();

      if (input === correct) {
        const img = steps[currentStep].image || "https://upload.wikimedia.org/wikipedia/commons/thumb/6/64/Flag_of_Lyon.svg/320px-Flag_of_Lyon.svg.png";

        const box = document.getElementById("culture-box");
        box.innerHTML = `
          <p>üìñ ${steps[currentStep].culture}</p>
          <img src="${img}" alt="Illustration" style="max-width:100%; border-radius:8px; margin-top:10px;">
        `;
        box.classList.add("show");

        currentStep++;
        document.getElementById("answer").value = "";

        if (currentStep >= steps.length) {
          document.getElementById("status").innerText = "üéâ F√©licitations, vous avez termin√© l‚ÄôEscape Game de Lyon !";
          document.getElementById("question-container").classList.add("hidden");
        } else {
          document.getElementById("status").innerText = "‚û°Ô∏è Direction l‚Äô√©tape suivante ! Suivez la ligne bleue.";
          document.getElementById("question-container").classList.add("hidden");
        }
      } else {
        alert("‚ùå Mauvaise r√©ponse !");
      }
    }

    function distance(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = x => (x * Math.PI) / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    // üóùÔ∏è Mode test secret
    function toggleTestMode() {
        testMode = !testMode;
        if (testMode) {
            document.getElementById("status").innerText = "üéÆ Mode test activ√©. Les √©nigmes sont visibles.";
            showQuestion(steps[currentStep].question);
            document.getElementById("next-btn").style.display = "inline-block";
            document.getElementById("validate-btn").disabled = false;
        } else {
            document.getElementById("next-btn").style.display = "none";

            // üîÑ On vide la question et on cache le cadre
            document.getElementById("question").innerText = "";
            document.getElementById("question-container").classList.add("hidden");
            document.getElementById("answer").value = "";
            document.getElementById("culture-box").classList.remove("show");

            // ‚¨áÔ∏è Relancer la g√©olocalisation, status sera mis √† jour par updatePosition()
            document.getElementById("status").innerText = "üìç Reprise du suivi GPS...";
            initMap();
        }
    }



  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCDm7NiUWX2d88Yo6MVSdSm00dt2O6xuGg&callback=initMap">
  </script>
</body>
</html>




